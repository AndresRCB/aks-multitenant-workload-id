# https://taskfile.dev

version: "3"

includes:
  aks: ./aks/Taskfile.yml
  apps: ./apps/Taskfile.yml

tasks:
  default:
    summary: "Default task TODO figure out the tfvars situation"
    aliases:
      - "apply"
    cmds:
      - terragrunt run-all apply -auto-approve --terragrunt-non-interactive --terragrunt-debug --terragrunt-log-level debug
    silent: false

  verify:
    cmds:
      - task check
    deps:
      - creds

  creds:
    dir: ./aks
    cmds:
      - task creds
 
  check:
    dir: ./apps
    cmds:
      - task check

  clean:
    cmds:
      - task aks:clean
      - task apps:clean

  killfiles:
    desc: Removes various state files and caches
    cmds:
      - rm -f terraform.tfstate
      - rm -rf aks/.terraform aks/.terragrunt-cache aks/.env aks/.terraform.lock.hcl aks/.task aks/terragrunt-debug.tfvars.json
      - rm -rf keyvault/.terragrunt-cache keyvault/.terraform.lock.hcl keyvault/terragrunt-debug.tfvars.json
      - rm -rf keyvault2/.terragrunt-cache keyvault2/.terraform.lock.hcl keyvault2/terragrunt-debug.tfvars.json
      - rm -rf apps/.terraform apps/.terragrunt-cache apps/.terraform.lock.hcl apps/terragrunt-debug.tfvars.json apps/.task

  destroy:
    cmds:
      - terragrunt run-all destroy -auto-approve -var-file $(pwd)/terraform.tfvars --terragrunt-non-interactive

  kill:
    cmds:
      - az group delete --no-wait -y -n {{.RG1}}
      - az group delete --no-wait -y -n {{.RG2}} --subscription {{.demo_subscription_id2}}
      - task: killfiles
    vars:
      RG1:
        sh: terragrunt output -raw resource_group_name --terragrunt-working-dir ./aks
      RG2:
        sh: terragrunt output -raw resource_group_name --terragrunt-working-dir ./keyvault2
    